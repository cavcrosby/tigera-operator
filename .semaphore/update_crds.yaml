version: v1.0
name: Operator CD
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
global_job_config:
  secrets:
    - name: docker-hub
    # Mount the github SSH secret for pulling private repositories.
    - name: private-repo
  prologue:
    commands:
      - echo $DOCKERHUB_PASSWORD | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
      # Correct permissions since they are too open by default:
      - chmod 0600 ~/.keys/*
      # Add the key to the ssh agent:
      - ssh-add ~/.keys/*
      # Free up some space
      - sudo rm -rf ~/.kiex ~/.phpbrew ~/.rbenv ~/.nvm ~/.kerl
      # Semaphore mounts a copy-on-write FS as /var/lib/docker in order to provide a pre-loaded cache of
      # some images. However, the cache is not useful to us and the copy-on-write FS is a big problem given
      # how much we churn docker containers during testing.  Disable it.
      - sudo systemctl stop docker
      - sudo umount /var/lib/docker && sudo killall qemu-nbd || true
      - sudo systemctl start docker
      - echo Branch $BRANCH
      - checkout
      - git fetch --unshallow
      - git config remote.origin.fetch '+refs/heads/*:refs/remotes/origin/*'
      - git fetch --all
      - git checkout $BRANCH

blocks:
  - name: Create PR
    task:
      secrets:
        - name: quay-robot-semaphore_v2
      jobs:
        - name: Build
          commands:
            - echo Calico Version $(cat config/calico_versions.yml | grep ^title);
            - echo Enterprise Version $(cat config/enterprise_versions.yml | grep ^title);
            - make gen-versions;
